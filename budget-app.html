<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0f1419">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Budżet Domowy">
    <title>Budżet Domowy</title>
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="icon" type="image/jpeg" sizes="1024x1024" href="/newicon.jpg">
    <link rel="apple-touch-icon" href="/newicon.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-header">
                <h1>💰 Budżet Domowy</h1>
                <p>Wprowadź PIN aby kontynuować</p>
            </div>
            
            <div class="pin-input-container">
                <input type="password" class="pin-digit" maxlength="1" id="pin1" inputmode="numeric">
                <input type="password" class="pin-digit" maxlength="1" id="pin2" inputmode="numeric">
                <input type="password" class="pin-digit" maxlength="1" id="pin3" inputmode="numeric">
                <input type="password" class="pin-digit" maxlength="1" id="pin4" inputmode="numeric">
            </div>

            <button class="btn btn-primary" onclick="login()">Zaloguj się</button>
            
            <div class="error-message" id="loginError">Nieprawidłowy PIN. Spróbuj ponownie.</div>
        </div>
    </div>

    <!-- Main App -->
    <div class="container hidden" id="mainApp">
        <div class="app-header">
            <div class="app-title">
                <h1>💰 Budżet Domowy</h1>
                <span class="badge">LIVE</span>
            </div>
            <div class="header-actions">
                <div class="month-nav">
                    <button class="icon-btn" onclick="changeViewMonth(-1)" title="Poprzedni miesiąc">◀</button>
                    <button class="month-label-btn" id="monthLabelBtn" onclick="goToCurrentMonth()" title="Przejdź do bieżącego miesiąca">
                        <span id="currentViewMonth">-</span>
                    </button>
                    <button class="icon-btn" onclick="changeViewMonth(1)" title="Następny miesiąc">▶</button>
                </div>
                <button class="icon-btn" onclick="openAdminPanel()" title="Ustawienia">⚙️</button>
                <button class="icon-btn" onclick="openExpenseAnalysisModal()" title="Analiza wydatków">📊</button>
                <button class="icon-btn" onclick="openIncomeAnalysisModal()" title="Analiza wpływów">📈</button>
                <button class="icon-btn" onclick="logout()" title="Wyloguj">🚪</button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card clickable" onclick="openBalanceModal()" role="button" tabindex="0" onkeydown="if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); openBalanceModal(); }" title="Kliknij, aby zaktualizować stan konta">
                <div class="stat-label">Aktualny stan konta</div>
                <div class="stat-value" id="currentBalance">0.00 zł</div>
                <div class="stat-subtext">Ostatnia aktualizacja</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Do najbliższego wpływu</div>
                <div class="stat-value" id="daysToIncome">-- dni</div>
                <div class="stat-subtext" id="nextIncomeDate">Brak zaplanowanych wpływów</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Zostaje po płatnościach</div>
                <div class="stat-value" id="afterPayments">0.00 zł</div>
                <div class="stat-subtext">Po uwzględnieniu zobowiązań</div>
            </div>
        </div>

        <!-- Payments List -->
        <div class="payments-section">
            <div class="section-header">
                <h2>📋 Zaplanowane płatności</h2>
            </div>
            <div class="payment-list" id="paymentsList">
                <div class="empty-state">
                    <div class="icon">📭</div>
                    <p>Brak zaplanowanych płatności</p>
                </div>
            </div>
        </div>

        <!-- Income List -->
        <div class="payments-section">
            <div class="section-header">
                <h2>💵 Zaplanowane wpływy</h2>
            </div>
            <div class="payment-list" id="incomeList">
                <div class="empty-state">
                    <div class="icon">💰</div>
                    <p>Brak zaplanowanych wpływów</p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <div class="action-btn" onclick="openBalanceModal()">
                <div class="icon">💳</div>
                <div class="text">
                    <h3>Aktualizuj stan</h3>
                    <p>Wprowadź aktualny stan konta</p>
                </div>
            </div>

            <div class="action-btn" onclick="openIncomeModal()">
                <div class="icon">💵</div>
                <div class="text">
                    <h3>Dodaj wpływ</h3>
                    <p>Zaplanuj wypłatę lub wpływ</p>
                </div>
            </div>

            <div class="action-btn" onclick="openPaymentModal()">
                <div class="icon">➕</div>
                <div class="text">
                    <h3>Dodaj płatność</h3>
                    <p>Zaplanuj wydatek</p>
                </div>
            </div>
        </div>

        <div class="mobile-action-dock">
            <button type="button" class="dock-btn dock-btn-balance" onclick="openBalanceModal()">💳 Aktualizuj stan</button>
            <button type="button" class="dock-btn dock-btn-income" onclick="openIncomeModal()">💵 Dodaj wpływ</button>
            <button type="button" class="dock-btn dock-btn-payment" onclick="openPaymentModal()">➕ Dodaj płatność</button>
        </div>
    </div>

    <!-- Update Balance Modal -->
    <div class="modal" id="balanceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💳 Aktualizuj stan konta</h2>
                <button class="close-btn" onclick="closeBalanceModal()">✕</button>
            </div>
            
            <div class="input-group">
                <label>Aktualny stan konta (zł)</label>
                <input type="number" id="balanceInput" placeholder="0.00" step="0.01">
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBalanceModal()">Anuluj</button>
                <button class="btn btn-primary" onclick="updateBalance()">Zapisz</button>
            </div>
        </div>
    </div>

    <div class="modal" id="balanceCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="balanceCategoryTitle">Kategoria zmiany</h2>
                <button class="close-btn" onclick="closeBalanceCategoryModal()">✕</button>
            </div>

            <p class="analysis-hint" id="balanceCategoryInfo"></p>

            <div class="balance-split-list" id="balanceCategorySplitList"></div>
            <button type="button" class="btn btn-secondary balance-split-add-btn" onclick="addBalanceCategoryRow()">+ Dodaj kategorię</button>
            <p class="analysis-hint hidden" id="balanceCategorySplitWarning"></p>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="cancelBalanceCategory()">Anuluj</button>
                <button class="btn btn-primary" onclick="confirmBalanceCategory()">Zapisz</button>
            </div>
        </div>
    </div>

    <div class="modal" id="expenseAnalysisModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📊 Analiza wydatków</h2>
                <button class="close-btn" onclick="closeExpenseAnalysisModal()">✕</button>
            </div>

            <div class="input-group">
                <label>Wybierz miesiąc</label>
                <input type="month" id="expenseAnalysisMonth" onchange="renderExpenseAnalysis()">
            </div>

            <div class="analysis-list" id="expenseAnalysisSummary"></div>

            <div id="expenseDetailsSection" class="hidden">
                <div class="analysis-divider"></div>
                <h3>Szczegóły wydatków</h3>
                <div class="analysis-list" id="expenseAnalysisDetails"></div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" id="expenseDetailsBtn" onclick="toggleExpenseDetails()">Szczegóły</button>
                <button class="btn btn-secondary" onclick="openIncomeAnalysisFromExpense()">Analiza wpływów</button>
                <button class="btn btn-primary" onclick="closeExpenseAnalysisModal()">Zamknij</button>
            </div>
        </div>
    </div>

    <div class="modal" id="expenseEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ Edytuj wydatek</h2>
                <button class="close-btn" onclick="closeExpenseEditModal()">✕</button>
            </div>

            <div class="input-group">
                <label>Kwota wydatku (zł)</label>
                <input type="number" id="expenseEditAmountInput" placeholder="0.00" step="0.01">
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeExpenseEditModal()">Anuluj</button>
                <button class="btn btn-primary" onclick="saveExpenseAmountFromAnalysis()">Zapisz</button>
            </div>
        </div>
    </div>

    <div class="modal" id="incomeAnalysisModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📈 Analiza wpływów</h2>
                <button class="close-btn" onclick="closeIncomeAnalysisModal()">✕</button>
            </div>

            <div class="input-group">
                <label>Wybierz miesiąc</label>
                <input type="month" id="incomeAnalysisMonth" onchange="renderIncomeAnalysis()">
            </div>

            <div class="analysis-list" id="incomeAnalysisList"></div>

            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeIncomeAnalysisModal()">Zamknij</button>
            </div>
        </div>
    </div>

    <!-- Add Income Modal -->
    <div class="modal" id="incomeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="incomeModalTitle">💵 Dodaj wpływ</h2>
                <button class="close-btn" onclick="closeIncomeModal()">✕</button>
            </div>
            
            <div class="input-group">
                <label>Nazwa wpływu</label>
                <input type="text" id="incomeName" placeholder="np. Wypłata, Premia, Zwrot" maxlength="120">
            </div>

            <div class="input-group">
                <label>Kwota (zł)</label>
                <input type="number" id="incomeAmount" placeholder="0.00" step="0.01">
            </div>

            <div class="input-group">
                <label>Data wpływu</label>
                <input type="text" id="incomeDate" placeholder="np. 05/03/2026" inputmode="numeric" maxlength="10" oninput="formatDateInput(this)" onblur="normalizeDateInput(this)">
            </div>

            <div class="input-group">
                <label>Częstotliwość</label>
                <div class="radio-group">
                    <div class="radio-option selected" onclick="selectIncomeFrequency('once')">
                        Jednorazowy
                    </div>
                    <div class="radio-option" onclick="selectIncomeFrequency('monthly')">
                        Co miesiąc
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary hidden" id="incomeDeleteBtn" onclick="deleteIncomeFromModal()">Usuń</button>
                <button class="btn btn-secondary" onclick="closeIncomeModal()">Anuluj</button>
                <button class="btn btn-primary" id="incomeSubmitBtn" onclick="saveIncome()">Dodaj</button>
            </div>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="paymentModalTitle">➕ Dodaj płatność</h2>
                <button class="close-btn" onclick="closePaymentModal()">✕</button>
            </div>
            
            <div class="input-group">
                <label>Nazwa płatności</label>
                <input type="text" id="paymentName" placeholder="np. Czynsz, Prąd, Internet" maxlength="120">
            </div>

            <div class="input-group">
                <label>Kwota (zł)</label>
                <input type="number" id="paymentAmount" placeholder="0.00" step="0.01">
            </div>

            <div class="input-group">
                <label>Data płatności</label>
                <input type="text" id="paymentDate" placeholder="np. 05/03/2026" inputmode="numeric" maxlength="10" oninput="formatDateInput(this)" onblur="normalizeDateInput(this)">
            </div>

            <div class="input-group">
                <label>Częstotliwość</label>
                <div class="radio-group">
                    <div class="radio-option selected" onclick="selectPaymentFrequency('once')">
                        Jednorazowy
                    </div>
                    <div class="radio-option" onclick="selectPaymentFrequency('monthly')">
                        Co miesiąc
                    </div>
                    <div class="radio-option" onclick="selectPaymentFrequency('selected')">
                        Wybrane miesiące
                    </div>
                </div>
            </div>

            <div class="input-group hidden" id="monthSelectorGroup">
                <label>Wybierz miesiące</label>
                <div class="month-selector">
                    <div class="month-btn" onclick="toggleMonth(1)">Sty</div>
                    <div class="month-btn" onclick="toggleMonth(2)">Lut</div>
                    <div class="month-btn" onclick="toggleMonth(3)">Mar</div>
                    <div class="month-btn" onclick="toggleMonth(4)">Kwi</div>
                    <div class="month-btn" onclick="toggleMonth(5)">Maj</div>
                    <div class="month-btn" onclick="toggleMonth(6)">Cze</div>
                    <div class="month-btn" onclick="toggleMonth(7)">Lip</div>
                    <div class="month-btn" onclick="toggleMonth(8)">Sie</div>
                    <div class="month-btn" onclick="toggleMonth(9)">Wrz</div>
                    <div class="month-btn" onclick="toggleMonth(10)">Paź</div>
                    <div class="month-btn" onclick="toggleMonth(11)">Lis</div>
                    <div class="month-btn" onclick="toggleMonth(12)">Gru</div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary hidden" id="paymentDeleteBtn" onclick="deletePaymentFromModal()">Usuń</button>
                <button class="btn btn-secondary" onclick="closePaymentModal()">Anuluj</button>
                <button class="btn btn-primary" id="paymentSubmitBtn" onclick="savePayment()">Dodaj</button>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>⚙️ Panel Administratora</h2>
                <button class="close-btn" onclick="closeAdminPanel()">✕</button>
            </div>
            
            <div class="input-group">
                <label>Aktualny PIN</label>
                <input type="password" id="currentPin" placeholder="••••" maxlength="4" inputmode="numeric">
            </div>
            
            <div class="input-group">
                <label>Nowy PIN</label>
                <input type="password" id="newPin" placeholder="••••" maxlength="4" inputmode="numeric">
            </div>
            
            <div class="input-group">
                <label>Potwierdź nowy PIN</label>
                <input type="password" id="confirmPin" placeholder="••••" maxlength="4" inputmode="numeric">
            </div>

            <div class="error-message" id="adminError"></div>
            <div class="success-message" id="adminSuccess">PIN został pomyślnie zmieniony!</div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeAdminPanel()">Anuluj</button>
                <button class="btn btn-primary" onclick="changePin()">Zmień PIN</button>
            </div>

            <div class="input-group">
                <label>Kopia zapasowa danych</label>
                <p class="backup-hint">Używamy jednego formatu backupu: SQLite <code>.db</code>. Pobierz kopię lokalnie i możesz ją później przywrócić.</p>
                <div class="backup-actions">
                    <button class="btn btn-secondary" onclick="downloadBackup()">Pobierz backup .db</button>
                </div>
                <div class="backup-actions backup-restore-actions">
                    <input type="file" id="backupFileInput" accept=".db,application/x-sqlite3" />
                    <button class="btn btn-secondary" onclick="restoreBackup()">Przywróć backup .db</button>
                </div>
            </div>
        </div>
    </div>

    <button class="install-app-btn" id="installAppBtn" onclick="installApp()" type="button">
        📲 Dodaj do ekranu głównego
    </button>

    <script type="module" src="/app.js"></script>
</body>
</html>
